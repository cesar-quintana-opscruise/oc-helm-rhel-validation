apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ .Values.serviceAccountName }}
  namespace: {{ .Release.Namespace }}
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ .Values.podName }}
  namespace: {{ .Release.Namespace }}
  labels:
    chart: "{{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}"
    opscruise-chart-version: {{ .Values.global.opscruiseChartVersion }}
    addonmanager.kubernetes.io/mode: {{ .Values.neLabels.addonmanagerKubernetesIoMode }}
    k8s-app: {{ .Values.neLabels.k8sapp }}
    kubernetes.io/cluster-service: "{{ .Values.neLabels.kubernetesIoClusterService }}"
    version: {{ .Values.neLabels.version }}
spec:
  {{- $nePort := 9100 -}}
  {{- if .Values.nodeExporterPort }}
  {{- $nePort = .Values.nodeExporterPort -}}
  {{- else if .Values.global.nodeExporterPort }}
  {{- $nePort = .Values.global.nodeExporterPort -}}
  {{- end }}
  {{- $K8S_CLUSTER_FQDN := "cluster.local" -}}
  {{ if .Values.global.k8sClusterFqdn }}
    {{- $K8S_CLUSTER_FQDN = .Values.global.k8sClusterFqdn -}}
  {{- end }}
  selector:
    matchLabels:
      k8s-app: {{ .Values.neLabels.k8sapp }}
      version: {{ .Values.neLabels.version }}
  updateStrategy:
    type: {{ .Values.updateStrategy.type }}
  template:
    metadata:
      labels:
        k8s-app: {{ .Values.neLabels.k8sapp }}
        opscruiseGroup: {{ .Values.neLabels.opscruiseGroup }}
        opscruisePerimeter: {{ .Values.neLabels.opscruisePerimeter }}
        opscruiseProduct: {{ .Values.neLabels.opscruiseProduct }}
        opscruiseStream: {{ .Values.neLabels.opscruiseStream }}
        version: {{ .Values.neLabels.version }}
        {{- if .Values.labels }}
        {{- range $label, $val := .Values.labels }}
        {{ $label }}: {{ $val }}
        {{- end }}
        {{- end }}
      annotations:
        opscruise.prometheus/path: {{ .Values.prometheus_scrape_config.path }}
        opscruise.prometheus/port: "{{ $nePort }}"
        opscruise.prometheus/scheme: {{ .Values.prometheus_scrape_config.scheme }}
        opscruise.prometheus/scrape: "{{ .Values.prometheus_scrape_config.scrape }}"
        checksum/env-config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
        {{- if .Values.annotations }}
        {{- range $annotation, $val := .Values.annotations }}
        {{ $annotation }}: {{ $val }}
        {{- end }}
        {{- end }}
    spec:
      serviceAccountName: {{ .Values.serviceAccountName }}
      containers:
        -
          args:
            - "{{ .Values.args.logVar }} {{ .Values.logLevel }}"
            - "{{ .Values.args.procFS }}"
            - "{{ .Values.args.sysFS }}"
            - "{{ .Values.args.webMaxRequests }}"
            - "{{ .Values.args.reversePathPacket }}"
            - "{{ .Values.args.enableAllMetrics }}"
            - "--web.listen-address=:{{ $nePort }}"
            {{- if .Values.global.namespaceFiltering.namespaceAllowList }}
            - "{{ .Values.args.enableNamespaceFiltering }}"
            {{- end }}
            - "{{ .Values.args.interface }} {{ .Values.interface }}"
            {{- if .Values.k8sgwEventConfigIpListURL }}
            - "{{ .Values.args.k8sgwEventConfigIpListURL }} {{ .Values.k8sgwEventConfigIpListURL | replace "K8S_CLUSTER_FQDN" $K8S_CLUSTER_FQDN }}"
            {{- end }}
            {{- if .Values.k8sgwAllConfigIpListURL }}
            - "{{ .Values.args.k8sgwAllConfigIpListURL }} {{ .Values.k8sgwAllConfigIpListURL | replace "K8S_CLUSTER_FQDN" $K8S_CLUSTER_FQDN }}"
            {{- end }}
            {{- if .Values.blackListIPs }}
            - "{{ .Values.args.blackListIP }} {{ .Values.blackListIPs }}"
            {{- end }}
            {{- if .Values.btfFilePath }}
            - "{{ .Values.args.btfFilePath }} {{ .Values.btfFilePath }}"
            {{- end }}
            {{- if .Values.kconfigFilePath }}
            - "{{ .Values.args.kconfigFilePath }} {{ .Values.kconfigFilePath }}"
            {{- end }}
            {{- range .Values.args.disableCollector }}
            - "{{ . }}"
            {{- end}}
            {{- range .Values.args.customArgs }}
            - "{{ . }}"
            {{- end}}
          image: "{{ .Values.image.repository }}:{{ .Values.image.node_exporter_bpf_core_tag }}"
          imagePullPolicy: {{ .Values.image.imagePullPolicy }}
          name: {{ .Values.name }}
          ports:
            -
              containerPort: {{ $nePort }}
              hostPort: {{ $nePort }}
              name: {{ .Values.ports.name }}
          resources:
{{ toYaml .Values.resources | indent 12 }}
          securityContext:
            capabilities:
              add:
                - {{ .Values.securityContext.addNETADMIN }}
                - {{ .Values.securityContext.addSYSADMIN }}
            privileged: {{ .Values.securityContext.privileged }}
          volumeMounts:
            -
              mountPath: {{ .Values.volumeMounts.etcOSReleasePath }}
              name: os-release
            -
              mountPath: {{ .Values.volumeMounts.varPath }}
              name: var
            -
              mountPath: {{ .Values.volumeMounts.devmountPath }}
              name: dev
            -
              mountPath: {{ .Values.volumeMounts.procmountPath }}
              name: proc
            -
              mountPath: {{ .Values.volumeMounts.sysmountPath }}
              name: sys
            -
              mountPath: {{ .Values.volumeMounts.rootfsmountPath }}
              name: rootfs
            -
              mountPath: {{ .Values.volumeMounts.libModulesPath }}
              name: lib-modules
            -
              mountPath: {{ .Values.volumeMounts.bootPath }}
              name: boot
            - 
              name: opsc-ne-configmap-volume
              mountPath: {{ .Values.volumeMounts.configMapPath }}
            -
              name: sys-kernel-debug
              mountPath: {{ .Values.volumeMounts.sysKernelDebugPath }}
      hostNetwork: {{ .Values.hostNetwork }}
      hostPID: {{ .Values.hostPID }}
      dnsPolicy: {{ .Values.dnsPolicy }}
      imagePullSecrets:
        -
          name: {{ .Values.imagePullSecrets.name }}
      tolerations:
      {{- if .Values.tolerations }}
      {{- toYaml .Values.tolerations | nindent 6 }}
      {{- else if .Values.global.tolerations }}
      {{- toYaml .Values.global.tolerations | nindent 6 }}
      {{- end }}
      {{- if .Values.global.daemonsetTolerations }}
      {{- toYaml .Values.global.daemonsetTolerations | nindent 6 }}
      {{- end }}
      
      {{- if .Values.priorityClassName }}
      priorityClassName: {{ .Values.priorityClassName }}
      {{- end }}
      volumes:
        -
          hostPath:
            path: {{ .Values.volumes.syskerneldebugpath }}
          name: sys-kernel-debug
        -
          hostPath:
            path: {{ .Values.volumes.etcosreleasepath }}
          name: os-release
        -
          hostPath:
            path: {{ .Values.volumes.varpath }}
          name: var
        -
          hostPath:
            path: {{ .Values.volumes.procpath }}
          name: proc
        -
          hostPath:
            path: {{ .Values.volumes.devpath }}
          name: dev
        -
          hostPath:
            path: {{ .Values.volumes.syspath }}
          name: sys
        -
          hostPath:
            path: {{ .Values.volumes.rootfspath }}
          name: rootfs
        -
          hostPath:
            path: {{ .Values.volumes.libmodulespath }}
          name: lib-modules
        -
          hostPath:
            path: {{ .Values.volumes.bootpath }}
          name: boot
        -
          name: opsc-ne-configmap-volume
          configMap:
            name: {{ .Values.configMapName }}
