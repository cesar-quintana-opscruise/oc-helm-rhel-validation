apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ .Values.serviceAccountName }}
  namespace: {{ .Release.Namespace }}

---
#amazonlinux
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ .Values.amazonlinux.name }}
  namespace: {{ .Release.Namespace }}
  labels:
    chart: "{{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}"
    opscruise-chart-version: {{ .Values.global.opscruiseChartVersion }}
    addonmanager.kubernetes.io/mode: {{ .Values.neLabels.addonmanagerKubernetesIoMode }}
    k8s-app: {{ .Values.neLabels.k8sapp }}
    kubernetes.io/cluster-service: "{{ .Values.neLabels.kubernetesIoClusterService }}"
    version: {{ .Values.neLabels.version }}
spec:
  {{- $nePort := 9100 -}}
  {{- if .Values.nodeExporterPort }}
  {{- $nePort := .Values.nodeExporterPort -}}
  {{- else if .Values.global.nodeExporterPort }}
  {{- $nePort := .Values.global.nodeExporterPort -}}
  {{- end }}
  selector:
    matchLabels:
      k8s-app: {{ .Values.neLabels.k8sapp }}
      version: {{ .Values.neLabels.version }}
  updateStrategy:
    type: {{ .Values.updateStrategy.type }}
  template:
    metadata:
      labels:
        k8s-app: {{ .Values.neLabels.k8sapp }}
        opscruiseGroup: {{ .Values.neLabels.opscruiseGroup }}
        opscruisePerimeter: {{ .Values.neLabels.opscruisePerimeter }}
        opscruiseProduct: {{ .Values.neLabels.opscruiseProduct }}
        opscruiseStream: {{ .Values.neLabels.opscruiseStream }}
        version: {{ .Values.neLabels.version }}
        {{- if .Values.labels }}
        {{- range $label, $val := .Values.labels }}
        {{ $label }}: {{ $val }}
        {{- end }}
        {{- end }}
      annotations:
        opscruise.prometheus/path: {{ .Values.prometheus_scrape_config.path }}
        opscruise.prometheus/port: "{{ $nePort }}"
        opscruise.prometheus/scheme: {{ .Values.prometheus_scrape_config.scheme }}
        opscruise.prometheus/scrape: "{{ .Values.prometheus_scrape_config.scrape }}"
        checksum/env-config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
        {{- if .Values.annotations }}
        {{- range $annotation, $val := .Values.annotations }}
        {{ $annotation }}: {{ $val }}
        {{- end }}
        {{- end }}
    spec:
      serviceAccountName: {{ .Values.serviceAccountName }}
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: {{ .Values.amazonlinux.matchExpressions.key }}
                operator: {{ .Values.amazonlinux.matchExpressions.operator }}
                values:
                - {{ .Values.amazonlinux.matchExpressions.values }}
      initContainers:
      - name: {{ .Values.amazonlinux.initContainer.name }}
        image: {{ .Values.amazonlinux.initContainer.image }}
        command: {{- toYaml .Values.amazonlinux.initContainer.command | nindent 8 }}
        volumeMounts:
        - name: {{ .Values.amazonlinux.initContainer.volumeMounts.name }}
          mountPath: {{ .Values.amazonlinux.initContainer.volumeMounts.mountPath }}
      containers:
        -
          args:
            - "{{ .Values.args.logVar }} {{ .Values.logLevel }}"
            - "{{ .Values.args.procFS }}"
            - "{{ .Values.args.sysFS }}"
            - "{{ .Values.args.webMaxRequests }}"
            - "{{ .Values.args.reversePathPacket }}"
            - "{{ .Values.args.enableAllMetrics }}"
            - --web.listen-address=:{{ $nePort }}
            - "{{ .Values.args.interface }} {{ .Values.interface }}"
            {{- if .Values.blackListIPs }}
            - "{{ .Values.args.blackListIP }} {{ .Values.blackListIPs }}"
            {{- end }}
            {{- range .Values.args.disableCollector }}
            - "{{ . }}"
            {{- end}}
            {{- range .Values.args.customArgs }}
            - "{{ . }}"
            {{- end}}
          image: "{{ .Values.image.repository }}:{{ .Values.image.node_exporter_tag }}"
          imagePullPolicy: {{ .Values.image.imagePullPolicy }}
          name: {{ .Values.name }}
          ports:
            -
              containerPort: {{ $nePort }}
              hostPort: {{ $nePort }}
              name: {{ .Values.ports.name }}
          resources:
{{ toYaml .Values.resources | indent 12 }}
          securityContext:
            capabilities:
              add:
                - {{ .Values.securityContext.addNETADMIN }}
                - {{ .Values.securityContext.addSYSADMIN }}
            privileged: {{ .Values.securityContext.privileged }}
          volumeMounts:
            -
              mountPath: {{ .Values.volumeMounts.devmountPath }}
              name: dev
            -
              mountPath: {{ .Values.volumeMounts.procmountPath }}
              name: proc
            -
              mountPath: {{ .Values.volumeMounts.sysmountPath }}
              name: sys
            -
              mountPath: {{ .Values.volumeMounts.rootfsmountPath }}
              name: rootfs
            -
              mountPath: {{ .Values.volumeMounts.libModulesPath }}
              name: lib-modules
            -
              mountPath: {{ .Values.volumeMounts.bootPath }}
              name: boot
            -
              mountPath: {{ .Values.volumeMounts.srcPath }}
              name: src
            -
              mountPath: {{ .Values.volumeMounts.bpfPath }}
              name: bpf
            - 
              name: opsc-ne-configmap-volume
              mountPath: {{ .Values.volumeMounts.configMapPath }}
      hostNetwork: {{ .Values.hostNetwork }}
      hostPID: {{ .Values.hostPID }}
      imagePullSecrets:
        -
          name: {{ .Values.imagePullSecrets.name }}
      tolerations:
      {{- if .Values.tolerations }}
      {{- toYaml .Values.tolerations | nindent 6 }}
      {{- else if .Values.global.tolerations }}
      {{- toYaml .Values.global.tolerations | nindent 6 }}
      {{- end }}
      {{- if .Values.global.daemonsetTolerations }}
      {{- toYaml .Values.global.daemonsetTolerations | nindent 6 }}
      {{- end }}
      
      {{- if .Values.priorityClassName }}
      priorityClassName: {{ .Values.priorityClassName }}
      {{- end }}
      volumes:
        -
          hostPath:
            path: {{ .Values.volumes.procpath }}
          name: proc
        -
          hostPath:
            path: {{ .Values.volumes.devpath }}
          name: dev
        -
          hostPath:
            path: {{ .Values.volumes.syspath }}
          name: sys
        -
          hostPath:
            path: {{ .Values.volumes.rootfspath }}
          name: rootfs
        -
          hostPath:
            path: {{ .Values.volumes.libmodulespath }}
          name: lib-modules
        -
          hostPath:
            path: {{ .Values.volumes.bootpath }}
          name: boot
        -
          hostPath:
            path: {{ .Values.volumes.bpfpath }}
          name: bpf
        -
          hostPath:
            path: {{ .Values.volumes.srcpath }}
          name: src
        -
          name: opsc-ne-configmap-volume
          configMap:
            name: {{ .Values.configMapName }}
---
#ubuntu 18.04
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ .Values.ubuntu18_04.name }}
  namespace: {{ .Release.Namespace }}
  labels:
    chart: "{{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}"
    opscruise-chart-version: {{ .Values.global.opscruiseChartVersion }}
    addonmanager.kubernetes.io/mode: {{ .Values.neLabels.addonmanagerKubernetesIoMode }}
    k8s-app: {{ .Values.neLabels.k8sapp }}
    kubernetes.io/cluster-service: "{{ .Values.neLabels.kubernetesIoClusterService }}"
    version: {{ .Values.neLabels.version }}
spec:
  {{- $nePort := 9100 -}}
  {{- if .Values.nodeExporterPort }}
  {{- $nePort := .Values.nodeExporterPort -}}
  {{- else if .Values.global.nodeExporterPort }}
  {{- $nePort := .Values.global.nodeExporterPort -}}
  {{- end }}
  selector:
    matchLabels:
      k8s-app: {{ .Values.neLabels.k8sapp }}
      version: {{ .Values.neLabels.version }}
  updateStrategy:
    type: {{ .Values.updateStrategy.type }}
  template:
    metadata:
      labels:
        k8s-app: {{ .Values.neLabels.k8sapp }}
        opscruiseGroup: {{ .Values.neLabels.opscruiseGroup }}
        opscruisePerimeter: {{ .Values.neLabels.opscruisePerimeter }}
        opscruiseProduct: {{ .Values.neLabels.opscruiseProduct }}
        opscruiseStream: {{ .Values.neLabels.opscruiseStream }}
        version: {{ .Values.neLabels.version }}
        {{- if .Values.labels }}
        {{- range $label, $val := .Values.labels }}
        {{ $label }}: {{ $val }}
        {{- end }}
        {{- end }}
      annotations:
        opscruise.prometheus/path: {{ .Values.prometheus_scrape_config.path }}
        opscruise.prometheus/port: "{{ $nePort }}"
        opscruise.prometheus/scheme: {{ .Values.prometheus_scrape_config.scheme }}
        opscruise.prometheus/scrape: "{{ .Values.prometheus_scrape_config.scrape }}"
        checksum/env-config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
        {{- if .Values.annotations }}
        {{- range $annotation, $val := .Values.annotations }}
        {{ $annotation }}: {{ $val }}
        {{- end }}
        {{- end }}
    spec:
      serviceAccountName: {{ .Values.serviceAccountName }}
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: {{ .Values.ubuntu18_04.matchExpressions.key }}
                operator: {{ .Values.ubuntu18_04.matchExpressions.operator }}
                values:
                - {{ .Values.ubuntu18_04.matchExpressions.values }}
      initContainers:
      - name: {{ .Values.ubuntu18_04.initContainer.name }}
        image: {{ .Values.ubuntu18_04.initContainer.image }}
        command: {{- toYaml .Values.ubuntu18_04.initContainer.command | nindent 8 }}
        volumeMounts:
        - name: {{ .Values.ubuntu18_04.initContainer.volumeMounts.name }}
          mountPath: {{ .Values.ubuntu18_04.initContainer.volumeMounts.mountPath }}
      containers:
        -
          args:
            - "{{ .Values.args.logVar }} {{ .Values.logLevel }}"
            - "{{ .Values.args.procFS }}"
            - "{{ .Values.args.sysFS }}"
            - "{{ .Values.args.webMaxRequests }}"
            - "{{ .Values.args.reversePathPacket }}"
            - "{{ .Values.args.enableAllMetrics }}"
            - --web.listen-address=:{{ $nePort }}
            - "{{ .Values.args.interface }} {{ .Values.interface }}"
            {{- if .Values.blackListIPs }}
            - "{{ .Values.args.blackListIP }} {{ .Values.blackListIPs }}"
            {{- end }}
            {{- range .Values.args.disableCollector }}
            - "{{ . }}"
            {{- end}}
            {{- range .Values.args.customArgs }}
            - "{{ . }}"
            {{- end}}
          image: "{{ .Values.image.repository }}:{{ .Values.image.node_exporter_tag }}"
          imagePullPolicy: {{ .Values.image.imagePullPolicy }}
          name: {{ .Values.name }}
          ports:
            -
              containerPort: {{ $nePort }}
              hostPort: {{ $nePort }}
              name: {{ .Values.ports.name }}
          resources:
{{ toYaml .Values.resources | indent 12 }}
          securityContext:
            capabilities:
              add:
                - {{ .Values.securityContext.addNETADMIN }}
                - {{ .Values.securityContext.addSYSADMIN }}
            privileged: {{ .Values.securityContext.privileged }}
          volumeMounts:
            -
              mountPath: {{ .Values.volumeMounts.devmountPath }}
              name: dev
            -
              mountPath: {{ .Values.volumeMounts.procmountPath }}
              name: proc
            -
              mountPath: {{ .Values.volumeMounts.sysmountPath }}
              name: sys
            -
              mountPath: {{ .Values.volumeMounts.rootfsmountPath }}
              name: rootfs
            -
              mountPath: {{ .Values.volumeMounts.libModulesPath }}
              name: lib-modules
            -
              mountPath: {{ .Values.volumeMounts.bootPath }}
              name: boot
            -
              mountPath: {{ .Values.volumeMounts.srcPath }}
              name: src
            -
              mountPath: {{ .Values.volumeMounts.bpfPath }}
              name: bpf
            - 
              name: opsc-ne-configmap-volume
              mountPath: {{ .Values.volumeMounts.configMapPath }}
      hostNetwork: {{ .Values.hostNetwork }}
      hostPID: {{ .Values.hostPID }}
      imagePullSecrets:
        -
          name: {{ .Values.imagePullSecrets.name }}
      tolerations:
      {{- if .Values.tolerations }}
      {{- toYaml .Values.tolerations | nindent 6 }}
      {{- else if .Values.global.tolerations }}
      {{- toYaml .Values.global.tolerations | nindent 6 }}
      {{- end }}
      {{- if .Values.global.daemonsetTolerations }}
      {{- toYaml .Values.global.daemonsetTolerations | nindent 6 }}
      {{- end }}
      
      {{- if .Values.priorityClassName }}
      priorityClassName: {{ .Values.priorityClassName }}
      {{- end }}
      volumes:
        -
          hostPath:
            path: {{ .Values.volumes.procpath }}
          name: proc
        -
          hostPath:
            path: {{ .Values.volumes.devpath }}
          name: dev
        -
          hostPath:
            path: {{ .Values.volumes.syspath }}
          name: sys
        -
          hostPath:
            path: {{ .Values.volumes.rootfspath }}
          name: rootfs
        -
          hostPath:
            path: {{ .Values.volumes.libmodulespath }}
          name: lib-modules
        -
          hostPath:
            path: {{ .Values.volumes.bootpath }}
          name: boot
        -
          hostPath:
            path: {{ .Values.volumes.srcpath }}
          name: src
        -
          hostPath:
            path: {{ .Values.volumes.bpfpath }}
          name: bpf
        -
          name: opsc-ne-configmap-volume
          configMap:
            name: {{ .Values.configMapName }}
---
#ubuntu 20.04
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ .Values.ubuntu20_04.name }}
  namespace: {{ .Release.Namespace }}
  labels:
    chart: "{{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}"
    opscruise-chart-version: {{ .Values.global.opscruiseChartVersion }}
    addonmanager.kubernetes.io/mode: {{ .Values.neLabels.addonmanagerKubernetesIoMode }}
    k8s-app: {{ .Values.neLabels.k8sapp }}
    kubernetes.io/cluster-service: "{{ .Values.neLabels.kubernetesIoClusterService }}"
    version: {{ .Values.neLabels.version }}
spec:
  {{- $nePort := 9100 -}}
  {{- if .Values.nodeExporterPort }}
  {{- $nePort := .Values.nodeExporterPort -}}
  {{- else if .Values.global.nodeExporterPort }}
  {{- $nePort := .Values.global.nodeExporterPort -}}
  {{- end }}
  selector:
    matchLabels:
      k8s-app: {{ .Values.neLabels.k8sapp }}
      version: {{ .Values.neLabels.version }}
  updateStrategy:
    type: {{ .Values.updateStrategy.type }}
  template:
    metadata:
      labels:
        k8s-app: {{ .Values.neLabels.k8sapp }}
        opscruiseGroup: {{ .Values.neLabels.opscruiseGroup }}
        opscruisePerimeter: {{ .Values.neLabels.opscruisePerimeter }}
        opscruiseProduct: {{ .Values.neLabels.opscruiseProduct }}
        opscruiseStream: {{ .Values.neLabels.opscruiseStream }}
        version: {{ .Values.neLabels.version }}
        {{- if .Values.labels }}
        {{- range $label, $val := .Values.labels }}
        {{ $label }}: {{ $val }}
        {{- end }}
        {{- end }}
      annotations:
        opscruise.prometheus/path: {{ .Values.prometheus_scrape_config.path }}
        opscruise.prometheus/port: "{{ $nePort }}"
        opscruise.prometheus/scheme: {{ .Values.prometheus_scrape_config.scheme }}
        opscruise.prometheus/scrape: "{{ .Values.prometheus_scrape_config.scrape }}"
        checksum/env-config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
      {{- if .Values.annotations }}
        {{- range $annotation, $val := .Values.annotations }}
        {{ $annotation }}: {{ $val }}
        {{- end }}
      {{- end }}
    spec:
      serviceAccountName: {{ .Values.serviceAccountName }}
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: {{ .Values.ubuntu20_04.matchExpressions.key }}
                operator: {{ .Values.ubuntu20_04.matchExpressions.operator }}
                values:
                - {{ .Values.ubuntu20_04.matchExpressions.values }}
      initContainers:
      - name: {{ .Values.ubuntu20_04.initContainer.name }}
        image: {{ .Values.ubuntu20_04.initContainer.image }}
        command: {{- toYaml .Values.ubuntu20_04.initContainer.command | nindent 8 }}
        volumeMounts:
        - name: {{ .Values.ubuntu20_04.initContainer.volumeMounts.name }}
          mountPath: {{ .Values.ubuntu20_04.initContainer.volumeMounts.mountPath }}
      containers:
        -
          args:
            - "{{ .Values.args.logVar }} {{ .Values.logLevel }}"
            - "{{ .Values.args.procFS }}"
            - "{{ .Values.args.sysFS }}"
            - "{{ .Values.args.webMaxRequests }}"
            - "{{ .Values.args.reversePathPacket }}"
            - "{{ .Values.args.enableAllMetrics }}"
            - --web.listen-address=:{{ $nePort }}
            - "{{ .Values.args.interface }} {{ .Values.interface }}"
            {{- if .Values.blackListIPs }}
            - "{{ .Values.args.blackListIP }} {{ .Values.blackListIPs }}"
            {{- end }}
            {{- range .Values.args.disableCollector }}
            - "{{ . }}"
            {{- end}}
            {{- range .Values.args.customArgs }}
            - "{{ . }}"
            {{- end}}
          image: "{{ .Values.image.repository }}:{{ .Values.image.node_exporter_tag }}"
          imagePullPolicy: {{ .Values.image.imagePullPolicy }}
          name: {{ .Values.name }}
          ports:
            -
              containerPort: {{ $nePort }}
              hostPort: {{ $nePort }}
              name: {{ .Values.ports.name }}
          resources:
{{ toYaml .Values.resources | indent 12 }}
          securityContext:
            capabilities:
              add:
                - {{ .Values.securityContext.addNETADMIN }}
                - {{ .Values.securityContext.addSYSADMIN }}
            privileged: {{ .Values.securityContext.privileged }}
          volumeMounts:
            -
              mountPath: {{ .Values.volumeMounts.devmountPath }}
              name: dev
            -
              mountPath: {{ .Values.volumeMounts.procmountPath }}
              name: proc
            -
              mountPath: {{ .Values.volumeMounts.sysmountPath }}
              name: sys
            -
              mountPath: {{ .Values.volumeMounts.rootfsmountPath }}
              name: rootfs
            -
              mountPath: {{ .Values.volumeMounts.libModulesPath }}
              name: lib-modules
            -
              mountPath: {{ .Values.volumeMounts.bootPath }}
              name: boot
            -
              mountPath: {{ .Values.volumeMounts.srcPath }}
              name: src
            -
              mountPath: {{ .Values.volumeMounts.bpfPath }}
              name: bpf
            -
              name: opsc-ne-configmap-volume
              mountPath: {{ .Values.volumeMounts.configMapPath }}
      hostNetwork: {{ .Values.hostNetwork }}
      hostPID: {{ .Values.hostPID }}
      imagePullSecrets:
        -
          name: {{ .Values.imagePullSecrets.name }}
      tolerations:
      {{- if .Values.tolerations }}
      {{- toYaml .Values.tolerations | nindent 6 }}
      {{- else if .Values.global.tolerations }}
      {{- toYaml .Values.global.tolerations | nindent 6 }}
      {{- end }}
      {{- if .Values.global.daemonsetTolerations }}
      {{- toYaml .Values.global.daemonsetTolerations | nindent 6 }}
      {{- end }}
      
      {{- if .Values.priorityClassName }}
      priorityClassName: {{ .Values.priorityClassName }}
      {{- end }}
      volumes:
        -
          hostPath:
            path: {{ .Values.volumes.procpath }}
          name: proc
        -
          hostPath:
            path: {{ .Values.volumes.devpath }}
          name: dev
        -
          hostPath:
            path: {{ .Values.volumes.syspath }}
          name: sys
        -
          hostPath:
            path: {{ .Values.volumes.rootfspath }}
          name: rootfs
        -
          hostPath:
            path: {{ .Values.volumes.libmodulespath }}
          name: lib-modules
        -
          hostPath:
            path: {{ .Values.volumes.bootpath }}
          name: boot
        -
          hostPath:
            path: {{ .Values.volumes.srcpath }}
          name: src
        -
          hostPath:
            path: {{ .Values.volumes.bpfpath }}
          name: bpf
        -
          name: opsc-ne-configmap-volume
          configMap:
            name: {{ .Values.configMapName }}
---
#centos8
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ .Values.centos8.name }}
  namespace: {{ .Release.Namespace }}
  labels:
    chart: "{{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}"
    opscruise-chart-version: {{ .Values.global.opscruiseChartVersion }}
    addonmanager.kubernetes.io/mode: {{ .Values.neLabels.addonmanagerKubernetesIoMode }}
    k8s-app: {{ .Values.neLabels.k8sapp }}
    kubernetes.io/cluster-service: "{{ .Values.neLabels.kubernetesIoClusterService }}"
    version: {{ .Values.neLabels.version }}
spec:
  {{- $nePort := 9100 -}}
  {{- if .Values.nodeExporterPort }}
  {{- $nePort := .Values.nodeExporterPort -}}
  {{- else if .Values.global.nodeExporterPort }}
  {{- $nePort := .Values.global.nodeExporterPort -}}
  {{- end }}
  selector:
    matchLabels:
      k8s-app: {{ .Values.neLabels.k8sapp }}
      version: {{ .Values.neLabels.version }}
  updateStrategy:
    type: {{ .Values.updateStrategy.type }}
  template:
    metadata:
      labels:
        k8s-app: {{ .Values.neLabels.k8sapp }}
        opscruiseGroup: {{ .Values.neLabels.opscruiseGroup }}
        opscruisePerimeter: {{ .Values.neLabels.opscruisePerimeter }}
        opscruiseProduct: {{ .Values.neLabels.opscruiseProduct }}
        opscruiseStream: {{ .Values.neLabels.opscruiseStream }}
        version: {{ .Values.neLabels.version }}
        {{- if .Values.labels }}
        {{- range $label, $val := .Values.labels }}
        {{ $label }}: {{ $val }}
        {{- end }}
        {{- end }}
      annotations:
        opscruise.prometheus/path: {{ .Values.prometheus_scrape_config.path }}
        opscruise.prometheus/port: "{{ $nePort }}"
        opscruise.prometheus/scheme: {{ .Values.prometheus_scrape_config.scheme }}
        opscruise.prometheus/scrape: "{{ .Values.prometheus_scrape_config.scrape }}"
        checksum/env-config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
        {{- if .Values.annotations }}
        {{- range $annotation, $val := .Values.annotations }}
        {{ $annotation }}: {{ $val }}
        {{- end }}
        {{- end }}
    spec:
      serviceAccountName: {{ .Values.serviceAccountName }}
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: {{ .Values.centos8.matchExpressions.key }}
                operator: {{ .Values.centos8.matchExpressions.operator }}
                values:
                - {{ .Values.centos8.matchExpressions.values }}
      initContainers:
      - name: {{ .Values.centos8.initContainer.name }}
        image: {{ .Values.centos8.initContainer.image }}
        command: {{- toYaml .Values.centos8.initContainer.command | nindent 8 }}
        volumeMounts:
        - name: {{ .Values.centos8.initContainer.volumeMounts.name }}
          mountPath: {{ .Values.centos8.initContainer.volumeMounts.mountPath }}
      containers:
        -
          args:
            - "{{ .Values.args.logVar }} {{ .Values.logLevel }}"
            - "{{ .Values.args.procFS }}"
            - "{{ .Values.args.sysFS }}"
            - "{{ .Values.args.webMaxRequests }}"
            - "{{ .Values.args.reversePathPacket }}"
            - "{{ .Values.args.enableAllMetrics }}"
            - --web.listen-address=:{{ $nePort }}
            - "{{ .Values.args.interface }} {{ .Values.interface }}"
            {{- if .Values.blackListIPs }}
            - "{{ .Values.args.blackListIP }} {{ .Values.blackListIPs }}"
            {{- end }}
            {{- range .Values.args.disableCollector }}
            - "{{ . }}"
            {{- end}}
            {{- range .Values.args.customArgs }}
            - "{{ . }}"
            {{- end}}
          image: "{{ .Values.image.repository }}:{{ .Values.image.node_exporter_tag }}"
          imagePullPolicy: {{ .Values.image.imagePullPolicy }}
          name: {{ .Values.name }}
          ports:
            -
              containerPort: {{ $nePort }}
              hostPort: {{ $nePort }}
              name: {{ .Values.ports.name }}
          resources:
{{ toYaml .Values.resources | indent 12 }}
          securityContext:
            capabilities:
              add:
                - {{ .Values.securityContext.addNETADMIN }}
                - {{ .Values.securityContext.addSYSADMIN }}
            privileged: {{ .Values.securityContext.privileged }}
          volumeMounts:
            -
              mountPath: {{ .Values.volumeMounts.devmountPath }}
              name: dev
            -
              mountPath: {{ .Values.volumeMounts.procmountPath }}
              name: proc
            -
              mountPath: {{ .Values.volumeMounts.sysmountPath }}
              name: sys
            -
              mountPath: {{ .Values.volumeMounts.rootfsmountPath }}
              name: rootfs
            -
              mountPath: {{ .Values.volumeMounts.libModulesPath }}
              name: lib-modules
            -
              mountPath: {{ .Values.volumeMounts.bootPath }}
              name: boot
            -
              mountPath: {{ .Values.volumeMounts.srcPath }}
              name: src
            -
              mountPath: {{ .Values.volumeMounts.bpfPath }}
              name: bpf
            - 
              name: opsc-ne-configmap-volume
              mountPath: {{ .Values.volumeMounts.configMapPath }}
      hostNetwork: {{ .Values.hostNetwork }}
      hostPID: {{ .Values.hostPID }}
      imagePullSecrets:
        -
          name: {{ .Values.imagePullSecrets.name }}
      tolerations:
      {{- if .Values.tolerations }}
      {{- toYaml .Values.tolerations | nindent 6 }}
      {{- else if .Values.global.tolerations }}
      {{- toYaml .Values.global.tolerations | nindent 6 }}
      {{- end }}
      {{- if .Values.global.daemonsetTolerations }}
      {{- toYaml .Values.global.daemonsetTolerations | nindent 6 }}
      {{- end }}
      
      {{- if .Values.priorityClassName }}
      priorityClassName: {{ .Values.priorityClassName }}
      {{- end }}
      volumes:
        -
          hostPath:
            path: {{ .Values.volumes.procpath }}
          name: proc
        -
          hostPath:
            path: {{ .Values.volumes.devpath }}
          name: dev
        -
          hostPath:
            path: {{ .Values.volumes.syspath }}
          name: sys
        -
          hostPath:
            path: {{ .Values.volumes.rootfspath }}
          name: rootfs
        -
          hostPath:
            path: {{ .Values.volumes.libmodulespath }}
          name: lib-modules
        -
          hostPath:
            path: {{ .Values.volumes.bootpath }}
          name: boot
        -
          hostPath:
            path: {{ .Values.volumes.srcpath }}
          name: src
        -
          hostPath:
            path: {{ .Values.volumes.bpfpath }}
          name: bpf
        -
          name: opsc-ne-configmap-volume
          configMap:
            name: {{ .Values.configMapName }}

---
#centos7
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ .Values.centos7.name }}
  namespace: {{ .Release.Namespace }}
  labels:
    chart: "{{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}"
    opscruise-chart-version: {{ .Values.global.opscruiseChartVersion }}
    addonmanager.kubernetes.io/mode: {{ .Values.neLabels.addonmanagerKubernetesIoMode }}
    k8s-app: {{ .Values.neLabels.k8sapp }}
    kubernetes.io/cluster-service: "{{ .Values.neLabels.kubernetesIoClusterService }}"
    version: {{ .Values.neLabels.version }}
spec:
  {{- $nePort := 9100 -}}
  {{- if .Values.nodeExporterPort }}
  {{- $nePort := .Values.nodeExporterPort -}}
  {{- else if .Values.global.nodeExporterPort }}
  {{- $nePort := .Values.global.nodeExporterPort -}}
  {{- end }}
  selector:
    matchLabels:
      k8s-app: {{ .Values.neLabels.k8sapp }}
      version: {{ .Values.neLabels.version }}
  updateStrategy:
    type: {{ .Values.updateStrategy.type }}
  template:
    metadata:
      labels:
        k8s-app: {{ .Values.neLabels.k8sapp }}
        opscruiseGroup: {{ .Values.neLabels.opscruiseGroup }}
        opscruisePerimeter: {{ .Values.neLabels.opscruisePerimeter }}
        opscruiseProduct: {{ .Values.neLabels.opscruiseProduct }}
        opscruiseStream: {{ .Values.neLabels.opscruiseStream }}
        version: {{ .Values.neLabels.version }}
        {{- if .Values.labels }}
        {{- range $label, $val := .Values.labels }}
        {{ $label }}: {{ $val }}
        {{- end }}
        {{- end }}
      annotations:
        opscruise.prometheus/path: {{ .Values.prometheus_scrape_config.path }}
        opscruise.prometheus/port: "{{ $nePort }}"
        opscruise.prometheus/scheme: {{ .Values.prometheus_scrape_config.scheme }}
        opscruise.prometheus/scrape: "{{ .Values.prometheus_scrape_config.scrape }}"
        checksum/env-config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
        {{- if .Values.annotations }}
        {{- range $annotation, $val := .Values.annotations }}
        {{ $annotation }}: {{ $val }}
        {{- end }}
        {{- end }}
    spec:
      serviceAccountName: {{ .Values.serviceAccountName }}
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: {{ .Values.centos7.matchExpressions.key }}
                operator: {{ .Values.centos7.matchExpressions.operator }}
                values:
                - {{ .Values.centos7.matchExpressions.values }}
      initContainers:
      - name: {{ .Values.centos7.initContainer.name }}
        image: {{ .Values.centos7.initContainer.image }}
        command: {{- toYaml .Values.centos7.initContainer.command | nindent 8 }}
        volumeMounts:
        - name: {{ .Values.centos7.initContainer.volumeMounts.name }}
          mountPath: {{ .Values.centos7.initContainer.volumeMounts.mountPath }}
      containers:
        -
          args:
            - "{{ .Values.args.logVar }} {{ .Values.logLevel }}"
            - "{{ .Values.args.procFS }}"
            - "{{ .Values.args.sysFS }}"
            - "{{ .Values.args.webMaxRequests }}"
            - "{{ .Values.args.reversePathPacket }}"
            - "{{ .Values.args.enableAllMetrics }}"
            - --web.listen-address=:{{ $nePort }}
            - "{{ .Values.args.interface }} {{ .Values.interface }}"
            {{- if .Values.blackListIPs }}
            - "{{ .Values.args.blackListIP }} {{ .Values.blackListIPs }}"
            {{- end }}
            {{- range .Values.args.disableCollector }}
            - "{{ . }}"
            {{- end}}
            {{- range .Values.args.customArgs }}
            - "{{ . }}"
            {{- end}}
          image: "{{ .Values.image.repository }}:{{ .Values.image.node_exporter_tag }}"
          imagePullPolicy: {{ .Values.image.imagePullPolicy }}
          name: {{ .Values.name }}
          ports:
            -
              containerPort: {{ $nePort }}
              hostPort: {{ $nePort }}
              name: {{ .Values.ports.name }}
          resources:
{{ toYaml .Values.resources | indent 12 }}
          securityContext:
            capabilities:
              add:
                - {{ .Values.securityContext.addNETADMIN }}
                - {{ .Values.securityContext.addSYSADMIN }}
            privileged: {{ .Values.securityContext.privileged }}
          volumeMounts:
            -
              mountPath: {{ .Values.volumeMounts.devmountPath }}
              name: dev
            -
              mountPath: {{ .Values.volumeMounts.procmountPath }}
              name: proc
            -
              mountPath: {{ .Values.volumeMounts.sysmountPath }}
              name: sys
            -
              mountPath: {{ .Values.volumeMounts.rootfsmountPath }}
              name: rootfs
            -
              mountPath: {{ .Values.volumeMounts.libModulesPath }}
              name: lib-modules
            -
              mountPath: {{ .Values.volumeMounts.bootPath }}
              name: boot
            -
              mountPath: {{ .Values.volumeMounts.srcPath }}
              name: src
            -
              mountPath: {{ .Values.volumeMounts.bpfPath }}
              name: bpf
            - 
              name: opsc-ne-configmap-volume
              mountPath: {{ .Values.volumeMounts.configMapPath }}
      hostNetwork: {{ .Values.hostNetwork }}
      hostPID: {{ .Values.hostPID }}
      imagePullSecrets:
        -
          name: {{ .Values.imagePullSecrets.name }}
      tolerations:
      {{- if .Values.tolerations }}
      {{- toYaml .Values.tolerations | nindent 6 }}
      {{- else if .Values.global.tolerations }}
      {{- toYaml .Values.global.tolerations | nindent 6 }}
      {{- end }}
      {{- if .Values.global.daemonsetTolerations }}
      {{- toYaml .Values.global.daemonsetTolerations | nindent 6 }}
      {{- end }}
      
      {{- if .Values.priorityClassName }}
      priorityClassName: {{ .Values.priorityClassName }}
      {{- end }}
      volumes:
        -
          hostPath:
            path: {{ .Values.volumes.procpath }}
          name: proc
        -
          hostPath:
            path: {{ .Values.volumes.devpath }}
          name: dev
        -
          hostPath:
            path: {{ .Values.volumes.syspath }}
          name: sys
        -
          hostPath:
            path: {{ .Values.volumes.rootfspath }}
          name: rootfs
        -
          hostPath:
            path: {{ .Values.volumes.libmodulespath }}
          name: lib-modules
        -
          hostPath:
            path: {{ .Values.volumes.bootpath }}
          name: boot
        -
          hostPath:
            path: {{ .Values.volumes.srcpath }}
          name: src
        -
          hostPath:
            path: {{ .Values.volumes.bpfpath }}
          name: bpf
        -
          name: opsc-ne-configmap-volume
          configMap:
            name: {{ .Values.configMapName }}

---
#GKE cluster nodes chromium os(container optimized os)
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ .Values.gke.name }}
  namespace: {{ .Release.Namespace }}
  labels:
    chart: "{{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}"
    opscruise-chart-version: {{ .Values.global.opscruiseChartVersion }}
    addonmanager.kubernetes.io/mode: {{ .Values.neLabels.addonmanagerKubernetesIoMode }}
    k8s-app: {{ .Values.neLabels.k8sapp }}
    kubernetes.io/cluster-service: "{{ .Values.neLabels.kubernetesIoClusterService }}"
    version: {{ .Values.neLabels.version }}
spec:
  {{- $nePort := 9100 -}}
  {{- if .Values.nodeExporterPort }}
  {{- $nePort := .Values.nodeExporterPort -}}
  {{- else if .Values.global.nodeExporterPort }}
  {{- $nePort := .Values.global.nodeExporterPort -}}
  {{- end }}
  selector:
    matchLabels:
      k8s-app: {{ .Values.neLabels.k8sapp }}
      version: {{ .Values.neLabels.version }}
  updateStrategy:
    type: {{ .Values.updateStrategy.type }}
  template:
    metadata:
      labels:
        k8s-app: {{ .Values.neLabels.k8sapp }}
        opscruiseGroup: {{ .Values.neLabels.opscruiseGroup }}
        opscruisePerimeter: {{ .Values.neLabels.opscruisePerimeter }}
        opscruiseProduct: {{ .Values.neLabels.opscruiseProduct }}
        opscruiseStream: {{ .Values.neLabels.opscruiseStream }}
        version: {{ .Values.neLabels.version }}
        {{- if .Values.labels }}
        {{- range $label, $val := .Values.labels }}
        {{ $label }}: {{ $val }}
        {{- end }}
        {{- end }}
      annotations:
        opscruise.prometheus/path: {{ .Values.prometheus_scrape_config.path }}
        opscruise.prometheus/port: "{{ $nePort }}"
        opscruise.prometheus/scheme: {{ .Values.prometheus_scrape_config.scheme }}
        opscruise.prometheus/scrape: "{{ .Values.prometheus_scrape_config.scrape }}"
        checksum/env-config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
        {{- if .Values.annotations }}
        {{- range $annotation, $val := .Values.annotations }}
        {{ $annotation }}: {{ $val }}
        {{- end }}
        {{- end }}
    spec:
      serviceAccountName: {{ .Values.serviceAccountName }}
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: {{ .Values.gke.matchExpressions.key }}
                operator: {{ .Values.gke.matchExpressions.operator }}
                values:
                - {{ .Values.gke.matchExpressions.values }}
      containers:
        -
          args:
            - "{{ .Values.args.logVar }} {{ .Values.logLevel }}"
            - "{{ .Values.args.procFS }}"
            - "{{ .Values.args.sysFS }}"
            - "{{ .Values.args.webMaxRequests }}"
            - "{{ .Values.args.reversePathPacket }}"
            - "{{ .Values.args.enableAllMetrics }}"
            - --web.listen-address=:{{ $nePort }}
            - "{{ .Values.args.interface }} {{ .Values.interface }}"
            {{- if .Values.blackListIPs }}
            - "{{ .Values.args.blackListIP }} {{ .Values.blackListIPs }}"
            {{- end }}
            {{- range .Values.args.disableCollector }}
            - "{{ . }}"
            {{- end}}
            {{- range .Values.args.customArgs }}
            - "{{ . }}"
            {{- end}}
          image: "{{ .Values.image.repository }}:{{ .Values.gke.nePrefixTag }}{{ .Values.image.node_exporter_tag }}"
          imagePullPolicy: {{ .Values.image.imagePullPolicy }}
          name: {{ .Values.name }}
          ports:
            -
              containerPort: {{ $nePort }}
              hostPort: {{ $nePort }}
              name: {{ .Values.ports.name }}
          resources:
{{ toYaml .Values.resources | indent 12 }}
          securityContext:
            capabilities:
              add:
                - {{ .Values.securityContext.addNETADMIN }}
                - {{ .Values.securityContext.addSYSADMIN }}
            privileged: {{ .Values.securityContext.privileged }}
          volumeMounts:
            -
              mountPath: {{ .Values.volumeMounts.devmountPath }}
              name: dev
            -
              mountPath: {{ .Values.volumeMounts.procmountPath }}
              name: proc
            -
              mountPath: {{ .Values.volumeMounts.sysmountPath }}
              name: sys
            -
              mountPath: {{ .Values.volumeMounts.rootfsmountPath }}
              name: rootfs
            -
              mountPath: {{ .Values.volumeMounts.varPath }}
              name: var
            -
              mountPath: {{ .Values.volumeMounts.etcPath }}
              name: etc
              readOnly: true
            -
              mountPath: {{ .Values.volumeMounts.bootPath }}
              name: boot
            -
              mountPath: {{ .Values.volumeMounts.bpfPath }}
              name: bpf
            - 
              name: opsc-ne-configmap-volume
              mountPath: {{ .Values.volumeMounts.configMapPath }}
      hostNetwork: {{ .Values.hostNetwork }}
      hostPID: {{ .Values.hostPID }}
      imagePullSecrets:
        -
          name: {{ .Values.imagePullSecrets.name }}
      tolerations:
      {{- if .Values.tolerations }}
      {{- toYaml .Values.tolerations | nindent 6 }}
      {{- else if .Values.global.tolerations }}
      {{- toYaml .Values.global.tolerations | nindent 6 }}
      {{- end }}
      {{- if .Values.global.daemonsetTolerations }}
      {{- toYaml .Values.global.daemonsetTolerations | nindent 6 }}
      {{- end }}
      
      {{- if .Values.priorityClassName }}
      priorityClassName: {{ .Values.priorityClassName }}
      {{- end }}
      volumes:
        -
          hostPath:
            path: {{ .Values.volumes.procpath }}
          name: proc
        -
          hostPath:
            path: {{ .Values.volumes.devpath }}
          name: dev
        -
          hostPath:
            path: {{ .Values.volumes.syspath }}
          name: sys
        -
          hostPath:
            path: {{ .Values.volumes.rootfspath }}
          name: rootfs
        -
          hostPath:
            path: {{ .Values.volumes.varpath }}
          name: var
        -
          hostPath:
            path: {{ .Values.volumes.etcpath }}
          name: etc
        -
          hostPath:
            path: {{ .Values.volumes.bootpath }}
          name: boot
        -
          hostPath:
            path: {{ .Values.volumes.bpfpath }}
          name: bpf
        -
          name: opsc-ne-configmap-volume
          configMap:
            name: {{ .Values.configMapName }}
---
#rhel-coreos
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ .Values.rhel_coreos.name }}
  namespace: {{ .Release.Namespace }}
  labels:
    chart: "{{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}"
    opscruise-chart-version: {{ .Values.global.opscruiseChartVersion }}
    addonmanager.kubernetes.io/mode: {{ .Values.neLabels.addonmanagerKubernetesIoMode }}
    k8s-app: {{ .Values.neLabels.k8sapp }}
    kubernetes.io/cluster-service: "{{ .Values.neLabels.kubernetesIoClusterService }}"
    version: {{ .Values.neLabels.version }}
spec:
  {{- $nePort := 9100 -}}
  {{- if .Values.nodeExporterPort }}
  {{- $nePort := .Values.nodeExporterPort -}}
  {{- else if .Values.global.nodeExporterPort }}
  {{- $nePort := .Values.global.nodeExporterPort -}}
  {{- end }}
  selector:
    matchLabels:
      k8s-app: {{ .Values.neLabels.k8sapp }}
      version: {{ .Values.neLabels.version }}
  updateStrategy:
    type: {{ .Values.updateStrategy.type }}
  template:
    metadata:
      labels:
        k8s-app: {{ .Values.neLabels.k8sapp }}
        opscruiseGroup: {{ .Values.neLabels.opscruiseGroup }}
        opscruisePerimeter: {{ .Values.neLabels.opscruisePerimeter }}
        opscruiseProduct: {{ .Values.neLabels.opscruiseProduct }}
        opscruiseStream: {{ .Values.neLabels.opscruiseStream }}
        version: {{ .Values.neLabels.version }}
        {{- if .Values.labels }}
        {{- range $label, $val := .Values.labels }}
        {{ $label }}: {{ $val }}
        {{- end }}
        {{- end }}
      annotations:
        opscruise.prometheus/path: {{ .Values.prometheus_scrape_config.path }}
        opscruise.prometheus/port: "{{ $nePort }}"
        opscruise.prometheus/scheme: {{ .Values.prometheus_scrape_config.scheme }}
        opscruise.prometheus/scrape: "{{ .Values.prometheus_scrape_config.scrape }}"
        checksum/env-config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
        {{- if .Values.annotations }}
        {{- range $annotation, $val := .Values.annotations }}
        {{ $annotation }}: {{ $val }}
        {{- end }}
        {{- end }}
    spec:
      serviceAccountName: {{ .Values.serviceAccountName }}
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: {{ .Values.rhel_coreos.matchExpressions.key }}
                operator: {{ .Values.rhel_coreos.matchExpressions.operator }}
                values:
                - {{ .Values.rhel_coreos.matchExpressions.values }}
      containers:
        -
          args:
            - "{{ .Values.args.logVar }} {{ .Values.logLevel }}"
            - "{{ .Values.args.procFS }}"
            - "{{ .Values.args.sysFS }}"
            - "{{ .Values.args.webMaxRequests }}"
            - "{{ .Values.args.reversePathPacket }}"
            - "{{ .Values.args.enableAllMetrics }}"
            - --web.listen-address=:{{ $nePort }}
            - "{{ .Values.args.interface }} {{ .Values.interface }}"
            {{- if .Values.blackListIPs }}
            - "{{ .Values.args.blackListIP }} {{ .Values.blackListIPs }}"
            {{- end }}
            {{- range .Values.args.disableCollector }}
            - "{{ . }}"
            {{- end}}
            {{- range .Values.args.customArgs }}
            - "{{ . }}"
            {{- end}}
          image: "{{ .Values.image.repository }}:{{ .Values.rhel_coreos.nePrefixTag }}{{ .Values.image.node_exporter_tag }}"
          imagePullPolicy: {{ .Values.image.imagePullPolicy }}
          name: {{ .Values.name }}
          ports:
            -
              containerPort: {{ $nePort }}
              hostPort: {{ $nePort }}
              name: {{ .Values.ports.name }}
          resources:
{{ toYaml .Values.resources | indent 12 }}
          securityContext:
            capabilities:
              add:
                - {{ .Values.securityContext.addNETADMIN }}
                - {{ .Values.securityContext.addSYSADMIN }}
            privileged: {{ .Values.securityContext.privileged }}
          volumeMounts:
            -
              mountPath: {{ .Values.volumeMounts.devmountPath }}
              name: dev
            -
              mountPath: {{ .Values.volumeMounts.procmountPath }}
              name: proc
            -
              mountPath: {{ .Values.volumeMounts.sysmountPath }}
              name: sys
            -
              mountPath: {{ .Values.volumeMounts.rootfsmountPath }}
              name: rootfs
            -
              mountPath: {{ .Values.volumeMounts.libModulesPath }}
              name: lib-modules
            -
              mountPath: {{ .Values.volumeMounts.bootPath }}
              name: boot
            -
              mountPath: {{ .Values.volumeMounts.bpfPath }}
              name: bpf
            - 
              name: opsc-ne-configmap-volume
              mountPath: {{ .Values.volumeMounts.configMapPath }}
      hostNetwork: {{ .Values.hostNetwork }}
      hostPID: {{ .Values.hostPID }}
      imagePullSecrets:
        -
          name: {{ .Values.imagePullSecrets.name }}
      tolerations:
      {{- if .Values.tolerations }}
      {{- toYaml .Values.tolerations | nindent 6 }}
      {{- else if .Values.global.tolerations }}
      {{- toYaml .Values.global.tolerations | nindent 6 }}
      {{- end }}
      {{- if .Values.global.daemonsetTolerations }}
      {{- toYaml .Values.global.daemonsetTolerations | nindent 6 }}
      {{- end }}
      
      {{- if .Values.priorityClassName }}
      priorityClassName: {{ .Values.priorityClassName }}
      {{- end }}
      volumes:
        -
          hostPath:
            path: {{ .Values.volumes.procpath }}
          name: proc
        -
          hostPath:
            path: {{ .Values.volumes.devpath }}
          name: dev
        -
          hostPath:
            path: {{ .Values.volumes.syspath }}
          name: sys
        -
          hostPath:
            path: {{ .Values.volumes.rootfspath }}
          name: rootfs
        -
          hostPath:
            path: {{ .Values.volumes.bootpath }}
          name: boot
        -
          hostPath:
            path: {{ .Values.volumes.libmodulespath }}
          name: lib-modules
        -
          hostPath:
            path: {{ .Values.volumes.bpfpath }}
          name: bpf
        -
          name: opsc-ne-configmap-volume
          configMap:
            name: {{ .Values.configMapName }}
---
#Assuming Linux Headers Already Installed
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ .Values.baseImage.name }}
  namespace: {{ .Release.Namespace }}
  labels:
    chart: "{{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}"
    opscruise-chart-version: {{ .Values.global.opscruiseChartVersion }}
    addonmanager.kubernetes.io/mode: {{ .Values.neLabels.addonmanagerKubernetesIoMode }}
    k8s-app: {{ .Values.neLabels.k8sapp }}
    kubernetes.io/cluster-service: "{{ .Values.neLabels.kubernetesIoClusterService }}"
    version: {{ .Values.neLabels.version }}
spec:
  {{- $nePort := 9100 -}}
  {{- if .Values.nodeExporterPort }}
  {{- $nePort := .Values.nodeExporterPort -}}
  {{- else if .Values.global.nodeExporterPort }}
  {{- $nePort := .Values.global.nodeExporterPort -}}
  {{- end }}
  selector:
    matchLabels:
      k8s-app: {{ .Values.neLabels.k8sapp }}
      version: {{ .Values.neLabels.version }}
  updateStrategy:
    type: {{ .Values.updateStrategy.type }}
  template:
    metadata:
      labels:
        k8s-app: {{ .Values.neLabels.k8sapp }}
        opscruiseGroup: {{ .Values.neLabels.opscruiseGroup }}
        opscruisePerimeter: {{ .Values.neLabels.opscruisePerimeter }}
        opscruiseProduct: {{ .Values.neLabels.opscruiseProduct }}
        opscruiseStream: {{ .Values.neLabels.opscruiseStream }}
        version: {{ .Values.neLabels.version }}
        {{- if .Values.labels }}
        {{- range $label, $val := .Values.labels }}
        {{ $label }}: {{ $val }}
        {{- end }}
        {{- end }}
      annotations:
        opscruise.prometheus/path: {{ .Values.prometheus_scrape_config.path }}
        opscruise.prometheus/port: "{{ $nePort }}"
        opscruise.prometheus/scheme: {{ .Values.prometheus_scrape_config.scheme }}
        opscruise.prometheus/scrape: "{{ .Values.prometheus_scrape_config.scrape }}"
        checksum/env-config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
        {{- if .Values.annotations }}
        {{- range $annotation, $val := .Values.annotations }}
        {{ $annotation }}: {{ $val }}
        {{- end }}
        {{- end }}
    spec:
      serviceAccountName: {{ .Values.serviceAccountName }}
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: {{ .Values.baseImage.matchExpressions.key }}
                operator: {{ .Values.baseImage.matchExpressions.operator }}
                values:
                - {{ .Values.baseImage.matchExpressions.values.amazonlinux }}
                - {{ .Values.baseImage.matchExpressions.values.ubuntu18_04 }}
                - {{ .Values.baseImage.matchExpressions.values.ubuntu20_04 }}
                - {{ .Values.baseImage.matchExpressions.values.centos8 }}
                - {{ .Values.baseImage.matchExpressions.values.centos7 }}
                - {{ .Values.baseImage.matchExpressions.values.rhel_coreos }}
              - key: {{ .Values.gke.matchExpressions.key }}
                operator: {{ .Values.baseImage.matchExpressions.operator }}
                values:
                - {{ .Values.baseImage.matchExpressions.values.chromiumcos }}
                
      containers:
        -
          args:
            - "{{ .Values.args.logVar }} {{ .Values.logLevel }}"
            - "{{ .Values.args.procFS }}"
            - "{{ .Values.args.sysFS }}"
            - "{{ .Values.args.webMaxRequests }}"
            - "{{ .Values.args.reversePathPacket }}"
            - "{{ .Values.args.enableAllMetrics }}"
            - --web.listen-address=:{{ $nePort }}
            - "{{ .Values.args.interface }} {{ .Values.interface }}"
            {{- if .Values.blackListIPs }}
            - "{{ .Values.args.blackListIP }} {{ .Values.blackListIPs }}"
            {{- end }}
            {{- range .Values.args.disableCollector }}
            - "{{ . }}"
            {{- end}}
            {{- range .Values.args.customArgs }}
            - "{{ . }}"
            {{- end}}
          image: "{{ .Values.image.repository }}:{{ .Values.image.node_exporter_tag }}"
          imagePullPolicy: {{ .Values.image.imagePullPolicy }}
          name: {{ .Values.name }}
          ports:
            -
              containerPort: {{ $nePort }}
              hostPort: {{ $nePort }}
              name: {{ .Values.ports.name }}
          resources:
{{ toYaml .Values.resources | indent 12 }}
          securityContext:
            capabilities:
              add:
                - {{ .Values.securityContext.addNETADMIN }}
                - {{ .Values.securityContext.addSYSADMIN }}
            privileged: {{ .Values.securityContext.privileged }}
          volumeMounts:
            -
              mountPath: {{ .Values.volumeMounts.devmountPath }}
              name: dev
            -
              mountPath: {{ .Values.volumeMounts.procmountPath }}
              name: proc
            -
              mountPath: {{ .Values.volumeMounts.sysmountPath }}
              name: sys
            -
              mountPath: {{ .Values.volumeMounts.rootfsmountPath }}
              name: rootfs
            -
              mountPath: {{ .Values.volumeMounts.libModulesPath }}
              name: lib-modules
            -
              mountPath: {{ .Values.volumeMounts.bootPath }}
              name: boot
            -
              mountPath: {{ .Values.volumeMounts.srcPath }}
              name: src
            -
              mountPath: {{ .Values.volumeMounts.bpfPath }}
              name: bpf
            - 
              name: opsc-ne-configmap-volume
              mountPath: {{ .Values.volumeMounts.configMapPath }}
      hostNetwork: {{ .Values.hostNetwork }}
      hostPID: {{ .Values.hostPID }}
      imagePullSecrets:
        -
          name: {{ .Values.imagePullSecrets.name }}
      tolerations:
      {{- if .Values.tolerations }}
      {{- toYaml .Values.tolerations | nindent 6 }}
      {{- else if .Values.global.tolerations }}
      {{- toYaml .Values.global.tolerations | nindent 6 }}
      {{- end }}
      {{- if .Values.global.daemonsetTolerations }}
      {{- toYaml .Values.global.daemonsetTolerations | nindent 6 }}
      {{- end }}
      
      {{- if .Values.priorityClassName }}
      priorityClassName: {{ .Values.priorityClassName }}
      {{- end }}
      volumes:
        -
          hostPath:
            path: {{ .Values.volumes.procpath }}
          name: proc
        -
          hostPath:
            path: {{ .Values.volumes.devpath }}
          name: dev
        -
          hostPath:
            path: {{ .Values.volumes.syspath }}
          name: sys
        -
          hostPath:
            path: {{ .Values.volumes.rootfspath }}
          name: rootfs
        -
          hostPath:
            path: {{ .Values.volumes.libmodulespath }}
          name: lib-modules
        -
          hostPath:
            path: {{ .Values.volumes.bootpath }}
          name: boot
        -
          hostPath:
            path: {{ .Values.volumes.srcpath }}
          name: src
        -
          hostPath:
            path: {{ .Values.volumes.bpfpath }}
          name: bpf
        -
          name: opsc-ne-configmap-volume
          configMap:
            name: {{ .Values.configMapName }}
